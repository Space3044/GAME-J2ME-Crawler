<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆçˆ¬è™«æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; transition: background-color 0.3s; }
        .card { margin-bottom: 1rem; transition: background-color 0.3s, border-color 0.3s; }
        .log-box {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .status-badge { font-size: 0.9em; }
        
        /* Dark Mode Overrides */
        [data-bs-theme="dark"] body { background-color: #212529; color: #e9ecef; }
        [data-bs-theme="dark"] .log-box { background-color: #2b3035; border-color: #495057; color: #e9ecef; }
        [data-bs-theme="dark"] .card { background-color: #2b3035; border-color: #495057; }
        [data-bs-theme="dark"] .list-group-item { background-color: #2b3035; border-color: #495057; color: #e9ecef; }
        [data-bs-theme="dark"] .list-group-item-action:hover { background-color: #343a40; }
        [data-bs-theme="dark"] .list-group-item.active { background-color: #373b3e; border-color: #495057; color: #fff; }
        /* Light mode active override */
        .list-group-item.active { background-color: #e9ecef; border-color: #dee2e6; color: #000; }
        
        /* Preview Box Dark Mode */
        [data-bs-theme="dark"] .preview-box { background-color: #2b3035 !important; border-color: #495057; color: #e9ecef; }
        .preview-box { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>æ¸¸æˆçˆ¬è™«æ§åˆ¶å°</h1>
            <button class="btn btn-outline-secondary" onclick="toggleDarkMode()">
                <span id="darkModeIcon">ğŸŒ™</span> åˆ‡æ¢æ¨¡å¼
            </button>
        </div>

        <div class="row">
            <!-- Left Column: Task Management -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header" id="taskFormHeader">
                        æ–°å»ºä»»åŠ¡
                    </div>
                    <div class="card-body">
                        <input type="hidden" id="editTaskFilename" value="">
                        <div class="mb-3">
                            <label class="form-label">ä»»åŠ¡åç§° (å¯é€‰)</label>
                            <input type="text" class="form-control" id="taskName" placeholder="é»˜è®¤è‡ªåŠ¨å‘½å">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">èµ·å§‹ ID</label>
                                <input type="number" class="form-control" id="startId" min="1" placeholder="ä¾‹å¦‚: 31895">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">ç»ˆæ­¢ ID</label>
                                <input type="number" class="form-control" id="endId" min="1" placeholder="ä¾‹å¦‚: 47658">
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="btnCreateTask" onclick="createTask()">åˆ›å»ºä»»åŠ¡</button>
                            <button class="btn btn-success" id="btnUpdateTask" onclick="updateTask()" style="display:none;">ä¿å­˜ä¿®æ”¹</button>
                            <button class="btn btn-outline-secondary" id="btnCancelEdit" onclick="cancelEdit()" style="display:none;">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        ä»»åŠ¡åˆ—è¡¨
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="loadTaskList()">åˆ·æ–°</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="taskList">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Crawler Control & Status -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <span class="me-2">å½“å‰ä»»åŠ¡:</span>
                            <strong id="activeTaskName" class="me-2">æœªé€‰æ‹©</strong>
                            <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="renameActiveTask()" id="renameBtn" style="display:none;">âœï¸</button>
                        </div>
                        <span id="crawlerStatusBadge" class="badge bg-secondary status-badge">æœªè¿è¡Œ</span>
                    </div>
                    <div class="card-body">
                        <div id="controlPanel" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" id="btnStart" onclick="startCrawler()">å¼€å§‹/ç»§ç»­</button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-warning" id="btnPause" onclick="pauseCrawler()">æš‚åœ</button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-danger" id="btnStop" onclick="stopCrawler()">åœæ­¢</button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-info text-white" onclick="exportTask()">å¯¼å‡º Excel</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">å»¶è¿Ÿ (ç§’)</span>
                                        <input type="number" class="form-control" id="delayInput" value="1.0" step="0.1" min="0.1">
                                        <button class="btn btn-outline-secondary" onclick="setDelay()">è®¾ç½®</button>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div class="btn-group">
                                        <button class="btn btn-outline-warning" onclick="checkIntegrity()">æ£€æŸ¥ç¼ºæ¼/é”™è¯¯</button>
                                        <button class="btn btn-outline-danger" onclick="retryFailed()">é‡è¯•å¤±è´¥é¡¹ç›® (<span id="failedCount">0</span>)</button>
                                    </div>
                                </div>
                            </div>

                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                            </div>

                            <div class="row text-center mb-3">
                                <div class="col-3">
                                    <small class="text-muted">å½“å‰ ID</small>
                                    <div class="h5" id="currentId">-</div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">å·²æŠ“å–</small>
                                    <div class="h5" id="crawledCount">0</div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted" title="é‡è¯•é˜Ÿåˆ—ä¸­çš„æ•°é‡">é‡è¯•é˜Ÿåˆ—</small>
                                    <div class="h5" id="queueSize">0</div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">æ€»è¿›åº¦</small>
                                    <div class="h5"><span id="progressText">0/0</span></div>
                                </div>
                            </div>

                            <div class="card preview-box mb-3">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">å½“å‰ URL</small>
                                    <div class="text-truncate">
                                        <a href="#" id="currentUrlLink" target="_blank" class="text-decoration-none">-</a>
                                    </div>
                                    
                                    <small class="text-muted d-block mt-1">å½“å‰æ ‡é¢˜</small>
                                    <div class="text-truncate fw-bold" id="currentTitle">-</div>
                                    
                                    <small class="text-muted d-block mt-1">ç®€ä»‹é¢„è§ˆ</small>
                                    <div class="text-truncate small text-secondary" id="currentDesc" style="max-height: 3em; overflow: hidden;">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="noTaskPanel" class="text-center py-5 text-muted">
                            è¯·ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªä»»åŠ¡æˆ–åˆ›å»ºä¸€ä¸ªæ–°ä»»åŠ¡
                        </div>

                        <h6>è¿è¡Œæ—¥å¿—</h6>
                        <div class="log-box" id="logBox"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let activeTaskFilename = null;
        let statusInterval = null;
        let lastStatus = null;

        // --- Dark Mode ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-bs-theme', newTheme);
            document.getElementById('darkModeIcon').innerText = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // --- Task Management ---

        async function loadTaskList() {
            try {
                const res = await fetch('/api/tasks');
                const tasks = await res.json();
                const list = document.getElementById('taskList');
                list.innerHTML = '';
                
                tasks.forEach(task => {
                    const activeClass = task.is_active ? 'active' : '';
                    // Format date nicely if possible, or just use raw
                    const dateStr = task.created_at.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/, '$1-$2-$3 $4:$5');
                    
                    // Use task name as display name
                    const displayName = task.name || task.filename.replace('.json', '');
                    
                    let statusBadge = '';
                    if (task.status === 'completed') {
                        statusBadge = '<span class="badge bg-success ms-1" style="font-size: 0.6rem;">å·²å®Œæˆ</span>';
                    }

                    const item = document.createElement('div');
                    item.className = `list-group-item list-group-item-action ${activeClass}`;
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 text-truncate" style="max-width: 150px;" title="${displayName}">${displayName}</h6>
                            <small class="text-muted" style="font-size: 0.7rem;">${dateStr}</small>
                        </div>
                        <p class="mb-1 small">ID: ${task.start_id} - ${task.end_id} ${statusBadge}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small>å·²æŠ“å–: ${task.count}</small>
                            <div>
                                <button class="btn btn-outline-primary btn-sm py-0" style="font-size: 0.7rem;" onclick="loadTask('${task.filename}')">åŠ è½½</button>
                                <button class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.7rem;" onclick="editTask('${task.filename}', '${task.name}', ${task.start_id}, ${task.end_id}); event.stopPropagation();">ç¼–è¾‘</button>
                                <button class="btn btn-outline-danger btn-sm py-0" style="font-size: 0.7rem;" onclick="deleteTask('${task.filename}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(item);
                    
                    if (task.is_active) {
                        activeTaskFilename = task.filename;
                        updateUIForActiveTask(task);
                    }
                });
                
                if (!activeTaskFilename) {
                    document.getElementById('controlPanel').style.display = 'none';
                    document.getElementById('noTaskPanel').style.display = 'block';
                    document.getElementById('activeTaskName').innerText = 'æœªé€‰æ‹©';
                    document.getElementById('renameBtn').style.display = 'none';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function createTask() {
            const name = document.getElementById('taskName').value;
            const startId = document.getElementById('startId').value;
            const endId = document.getElementById('endId').value;
            
            if (!startId || !endId) {
                alert('è¯·è¾“å…¥èµ·å§‹å’Œç»ˆæ­¢ ID');
                return;
            }

            const sId = parseInt(startId);
            const eId = parseInt(endId);

            if (isNaN(sId) || isNaN(eId) || sId <= 0 || eId <= 0) {
                alert('ID å¿…é¡»æ˜¯æ­£æ•´æ•°');
                return;
            }

            if (sId > eId) {
                alert('èµ·å§‹ ID ä¸èƒ½å¤§äºç»ˆæ­¢ ID');
                return;
            }
            
            try {
                const res = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        start_id: sId,
                        end_id: eId
                    })
                });
                const data = await res.json();
                if (data.status === 'created') {
                    loadTaskList();
                    // Auto load
                    loadTask(data.filename);
                } else {
                    if (data.error === 'exists') {
                        if (confirm('è¯¥èŒƒå›´çš„ä»»åŠ¡å·²å­˜åœ¨ã€‚æ˜¯å¦è¦åŠ è½½å®ƒï¼Ÿ\n(æ‚¨ä¹Ÿå¯ä»¥ç¨åé‡å‘½åå®ƒ)')) {
                            loadTask(data.task.filename);
                        }
                    } else {
                        alert('åˆ›å»ºå¤±è´¥: ' + data.error);
                    }
                }
            } catch (e) {
                alert('Error: ' + e);
            }
        }

        async function loadTask(filename) {
            try {
                const res = await fetch(`/api/tasks/${filename}/load`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'loaded') {
                    activeTaskFilename = filename;
                    loadTaskList(); // Refresh list to show active state
                    startStatusPolling();
                } else {
                    alert(data.error);
                }
            } catch (e) {
                alert('Error: ' + e);
            }
        }

        async function deleteTask(filename) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ•°æ®å°†ä¸¢å¤±ã€‚')) return;
            
            try {
                const res = await fetch(`/api/tasks/${filename}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.status === 'deleted') {
                    if (activeTaskFilename === filename) {
                        activeTaskFilename = null;
                        stopStatusPolling();
                    }
                    loadTaskList();
                } else {
                    alert(data.error);
                }
            } catch (e) {
                alert('Error: ' + e);
            }
        }
        
        async function renameActiveTask() {
            if (!activeTaskFilename) return;
            const currentName = document.getElementById('activeTaskName').innerText;
            const newName = prompt("è¯·è¾“å…¥æ–°çš„ä»»åŠ¡åç§°:", currentName);
            
            if (newName && newName !== currentName) {
                try {
                    const res = await fetch(`/api/tasks/${activeTaskFilename}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: newName })
                    });
                    const data = await res.json();
                    if (data.status === 'renamed') {
                        activeTaskFilename = data.filename; // Update filename reference
                        loadTaskList(); // Refresh list
                    } else {
                        alert('é‡å‘½åå¤±è´¥: ' + data.error);
                    }
                } catch (e) {
                    alert('Error: ' + e);
                }
            }
        }

        async function exportTask() {
            if (!activeTaskFilename) return;
            window.location.href = `/api/tasks/${activeTaskFilename}/export`;
        }

        function updateUIForActiveTask(task) {
            document.getElementById('controlPanel').style.display = 'block';
            document.getElementById('noTaskPanel').style.display = 'none';
            document.getElementById('activeTaskName').innerText = task.name || task.filename;
            document.getElementById('renameBtn').style.display = 'inline-block';
        }
        
        // --- Edit Task ---
        function editTask(filename, name, startId, endId) {
            document.getElementById('taskFormHeader').innerText = 'ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('editTaskFilename').value = filename;
            document.getElementById('taskName').value = name;
            document.getElementById('startId').value = startId;
            document.getElementById('endId').value = endId;
            
            document.getElementById('btnCreateTask').style.display = 'none';
            document.getElementById('btnUpdateTask').style.display = 'block';
            document.getElementById('btnCancelEdit').style.display = 'block';
        }
        
        function cancelEdit() {
            document.getElementById('taskFormHeader').innerText = 'æ–°å»ºä»»åŠ¡';
            document.getElementById('editTaskFilename').value = '';
            document.getElementById('taskName').value = '';
            // Reset to empty
            document.getElementById('startId').value = '';
            document.getElementById('endId').value = '';
            
            document.getElementById('btnCreateTask').style.display = 'block';
            document.getElementById('btnUpdateTask').style.display = 'none';
            document.getElementById('btnCancelEdit').style.display = 'none';
        }
        
        async function updateTask() {
            const filename = document.getElementById('editTaskFilename').value;
            const name = document.getElementById('taskName').value;
            const startId = document.getElementById('startId').value;
            const endId = document.getElementById('endId').value;
            
            if (!filename || !startId || !endId) return;
            
            try {
                const res = await fetch(`/api/tasks/${filename}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        start_id: parseInt(startId),
                        end_id: parseInt(endId)
                    })
                });
                const data = await res.json();
                if (data.status === 'updated') {
                    loadTaskList();
                    cancelEdit();
                    // If active task was updated, reload it?
                    if (activeTaskFilename === filename || activeTaskFilename === data.filename) {
                        loadTask(data.filename);
                    }
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e);
            }
        }

        // --- Crawler Control ---

        async function startCrawler() {
            await fetch('/api/crawler/start', { method: 'POST' });
            startStatusPolling();
        }

        async function pauseCrawler() {
            await fetch('/api/crawler/pause', { method: 'POST' });
        }

        async function stopCrawler() {
            await fetch('/api/crawler/stop', { method: 'POST' });
        }

        async function setDelay() {
            const delay = document.getElementById('delayInput').value;
            await fetch('/api/crawler/set_delay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ delay: delay })
            });
        }

        async function checkIntegrity() {
            // No confirmation needed
            try {
                const res = await fetch('/api/crawler/check_integrity', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'checked') {
                    alert(`æ£€æŸ¥å®Œæˆï¼\næ–°å¢å¤±è´¥é¡¹ç›®: ${data.added_count}\nå½“å‰å¤±è´¥æ€»æ•°: ${data.total_failed}`);
                } else {
                    alert('æ£€æŸ¥å¤±è´¥: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e);
            }
        }

        async function retryFailed() {
            const res = await fetch('/api/crawler/retry_failed', { method: 'POST' });
            const data = await res.json();
            if (data.status === 'added_to_queue') {
                alert(`å·²å°† ${data.count} ä¸ªå¤±è´¥é¡¹ç›®æ·»åŠ åˆ°é‡è¯•é˜Ÿåˆ—`);
            } else if (data.status === 'no_failed_ids') {
                alert('æ²¡æœ‰å¤±è´¥é¡¹ç›®');
            }
        }

        // --- Status Polling ---

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(updateStatus, 1000);
            updateStatus();
        }

        function stopStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = null;
        }

        async function updateStatus() {
            if (!activeTaskFilename) return;
            
            try {
                const res = await fetch('/api/crawler/status');
                const data = await res.json();
                
                if (!data.active) return;

                // Auto refresh task list on status change (e.g. running -> completed/stopped)
                if (lastStatus !== null && lastStatus !== data.status) {
                    loadTaskList();
                }
                lastStatus = data.status;

                // Update Badge
                const badge = document.getElementById('crawlerStatusBadge');
                if (data.running) {
                    if (data.paused) {
                        badge.className = 'badge bg-warning text-dark status-badge';
                        badge.innerText = 'å·²æš‚åœ';
                    } else {
                        badge.className = 'badge bg-success status-badge';
                        badge.innerText = 'è¿è¡Œä¸­';
                    }
                } else {
                    badge.className = 'badge bg-secondary status-badge';
                    badge.innerText = 'å·²åœæ­¢';
                }

                // Update Stats
                // Use display_id if available, otherwise fallback to current_id
                document.getElementById('currentId').innerText = (data.display_id !== undefined) ? data.display_id : data.current_id;
                document.getElementById('crawledCount').innerText = data.count;
                document.getElementById('failedCount').innerText = data.failed_count;
                document.getElementById('queueSize').innerText = data.queue_size;
                
                const total = data.total;
                // Calculate progress based on crawled count vs total range
                // Or (current_id - start_id) / total
                // Let's use (current_id - start_id + 1) / total for inclusive range
                // But current_id might be start_id if nothing done yet.
                
                let progress = 0;
                if (total > 0) {
                    // If completed, force 100%
                    if (data.status === 'completed') {
                        progress = 100;
                    } else {
                        // Calculate how many items we have processed (crawled + failed)
                        // This is better than relying on current_id which might jump
                        // But current_id is the cursor.
                        // Let's stick to cursor logic: (current_id - start_id) / total
                        // If current_id is 31895 (start), progress is 0.
                        // If current_id is 31896 (next), progress is 1/total.
                        const processed = data.current_id - data.start_id;
                        progress = (processed / total * 100).toFixed(1);
                        if (progress > 100) progress = 100;
                    }
                }
                
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressBar').innerText = `${progress}%`;
                
                if (data.status === 'completed') {
                    document.getElementById('progressText').innerText = `${total} / ${total}`;
                } else {
                    document.getElementById('progressText').innerText = `${data.current_id - data.start_id} / ${total}`;
                }

                // Update Current Info
                const urlLink = document.getElementById('currentUrlLink');
                urlLink.innerText = data.current_url || '-';
                urlLink.href = data.current_url || '#';
                
                document.getElementById('currentTitle').innerText = data.current_title || '-';
                document.getElementById('currentDesc').innerText = data.current_desc || '-';

                // Update Logs
                const logBox = document.getElementById('logBox');
                if (data.logs && data.logs.length > 0) {
                    logBox.innerHTML = data.logs.map(log => `<div>${log}</div>`).join('');
                    logBox.scrollTop = logBox.scrollHeight;
                }
                
                // Update delay input if changed externally
                if (document.activeElement.id !== 'delayInput') {
                    document.getElementById('delayInput').value = data.delay;
                }

            } catch (e) {
                console.error('Status poll error', e);
            }
        }

        // Init
        loadTaskList();
    </script>
</body>
</html>
